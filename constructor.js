

// ==UserScript==
// @name                Upador Automático Tribal Wars com Recrutamento de Paladino
// @namespace           Murilo KZC
// @include             **screen=main*
// @version             0.1.1
// @grant               GM_getResourceText
// @grant               GM_addStyle
// @grant               GM_getValue
// @grant               unsafeWindow
// @grant               none
// @updateURL    https://raw.githubusercontent.com/kozac/twscripts/main/constructor.js
// @downloadURL  https://raw.githubusercontent.com/kozac/twscripts/main/constructor.js
// ==/UserScript==

const Min_Tempo_Espera=8e5,Max_Tempo_Espera=9e5,Etapa="Etapa_1",Construção_Edificios_Ordem=!0,Quest_Interval_Minutes=1,Quest_Interval=6e4,NivelEstatuaAlvo="Nível 1",COOKIE_RECRUTAMENTO="recrutadoPaladino",DIAS_VALIDADE_COOKIE=99,Visualização_Geral="OVERVIEW_VIEW",Edificio_Principal="HEADQUARTERS_VIEW";let isRecruiting=!1,currentVillageId=null,csrfToken=null;function executarEtapa1(){let e=getEvoluir_vilas();if(console.log("Evoluir_vilas: "+e),e===Edificio_Principal)setInterval((function(){isRecruiting||Proxima_Construção()}),1e3);else if(e===Visualização_Geral){let e=document.getElementById("l_main");e&&e.children.length>0&&e.children[0].children.length>0?(e.children[0].children[0].click(),console.log("Clicou no botão de Visualização Geral.")):console.log("Botão de Visualização Geral não encontrado.")}}!function(){"use strict";console.log("-- Script do Tribal Wars ativado --"),createBuildingUI(),executarEtapa1(),setInterval(collectQuestRewards,6e4),setInterval(verificarEstatua,5e3)}(),setInterval((function(){var e=$("#buildqueue").find("tr").eq(1);if(e.length>0){let i=e.find("td").eq(1).find("span").eq(0).text().trim().replace(/\s/g,"").split(":");if(3===i.length){60*parseInt(i[0],10)*60+60*parseInt(i[1],10)+parseInt(i[2],10)<180&&(console.log("Completar Grátis"),e.find("td").eq(2).find("a").eq(2).click())}}$(".btn.btn-confirm-yes").each((function(){$(this).hasClass("hidden")||$(this).is(":disabled")||($(this).click(),console.log("Clicou no botão de confirmação."))}))}),500);let delay=Math.floor(1e5*Math.random()+8e5);function getEvoluir_vilas(){let e=window.location.href;if(console.log("Current URL: "+e),e.includes("overview")||e.includes("Visualização Geral"))return Visualização_Geral;if(e.includes("main")){const e=new URLSearchParams(window.location.search);return currentVillageId=e.get("village"),console.log("ID da Aldeia Atual: "+currentVillageId),csrfToken=getCSRFToken(),console.log("Token CSRF: "+csrfToken),Edificio_Principal}console.log("Não foi possível determinar a visualização atual.")}function getCSRFToken(){let e=document.querySelector('input[name="h"]');if(e)return e.value;let i=document.querySelector('meta[name="csrf-token"]');return i?i.getAttribute("content"):(console.log("Token CSRF não encontrado."),null)}function Proxima_Construção(){let e=getConstrução_proximo_edificio();if(void 0!==e){e.click(),console.log("Clicked on "+e.id);let i=e.id;updateBuildingUI(i),console.log("Próximo Edifício: "+i)}}function getConstrução_proximo_edificio(){let e,i=getConstrução_Edifcios_Serie();for(;void 0===e&&i.length>0;){var n=i.shift();let o=document.getElementById(n);if(o)if((o.offsetWidth>0||o.offsetHeight>0)&&(e=o),Construção_Edificios_Ordem)break}return e}function getConstrução_Edifcios_Serie(){var e=[];return e.push("main_buildlink_statue_1"),e.push("main_buildlink_wood_1"),e.push("main_buildlink_stone_1"),e.push("main_buildlink_iron_1"),e.push("main_buildlink_wood_2"),e.push("main_buildlink_stone_2"),e.push("main_buildlink_iron_2"),e.push("main_buildlink_wood_3"),e.push("main_buildlink_stone_2"),e.push("main_buildlink_iron_2"),e.push("main_buildlink_storage_2"),e.push("main_buildlink_storage_3"),e.push("main_buildlink_main_2"),e.push("main_buildlink_main_3"),e.push("main_buildlink_barracks_1"),e.push("main_buildlink_market_1"),e.push("main_buildlink_farm_2"),e.push("main_buildlink_farm_3"),e.push("main_buildlink_stone_3"),e.push("main_buildlink_iron_3"),e.push("main_buildlink_storage_4"),e.push("main_buildlink_wall_1"),e.push("main_buildlink_wall_2"),e.push("main_buildlink_market_2"),e.push("main_buildlink_wood_4"),e.push("main_buildlink_stone_4"),e.push("main_buildlink_iron_4"),e.push("main_buildlink_hide_2"),e.push("main_buildlink_hide_3"),e.push("main_buildlink_barracks_2"),e.push("main_buildlink_wood_5"),e.push("main_buildlink_wood_6"),e.push("main_buildlink_wood_7"),e.push("main_buildlink_storage_5"),e.push("main_buildlink_farm_4"),e.push("main_buildlink_farm_5"),e.push("main_buildlink_wood_8"),e.push("main_buildlink_stone_5"),e.push("main_buildlink_stone_6"),e.push("main_buildlink_wood_9"),e.push("main_buildlink_stone_7"),e.push("main_buildlink_iron_5"),e.push("main_buildlink_storage_6"),e.push("main_buildlink_farm_6"),e.push("main_buildlink_wood_10"),e.push("main_buildlink_wood_11"),e.push("main_buildlink_wood_12"),e.push("main_buildlink_barracks_3"),e.push("main_buildlink_barracks_4"),e.push("main_buildlink_barracks_5"),e.push("main_buildlink_stone_8"),e.push("main_buildlink_iron_6"),e.push("main_buildlink_storage_7"),e.push("main_buildlink_farm_7"),e.push("main_buildlink_storage_8"),e.push("main_buildlink_wood_13"),e.push("main_buildlink_stone_9"),e.push("main_buildlink_stone_10"),e.push("main_buildlink_iron_7"),e.push("main_buildlink_storage_9"),e.push("main_buildlink_farm_8"),e.push("main_buildlink_wood_14"),e.push("main_buildlink_stone_11"),e.push("main_buildlink_iron_8"),e.push("main_buildlink_barracks_6"),e.push("main_buildlink_storage_10"),e.push("main_buildlink_storage_11"),e.push("main_buildlink_wood_15"),e.push("main_buildlink_stone_12"),e.push("main_buildlink_iron_9"),e.push("main_buildlink_farm_9"),e.push("main_buildlink_wood_16"),e.push("main_buildlink_stone_13"),e.push("main_buildlink_iron_10"),e.push("main_buildlink_storage_12"),e.push("main_buildlink_wood_17"),e.push("main_buildlink_stone_14"),e.push("main_buildlink_iron_11"),e.push("main_buildlink_barracks_7"),e.push("main_buildlink_barracks_8"),e.push("main_buildlink_barracks_9"),e.push("main_buildlink_wood_18"),e.push("main_buildlink_stone_14"),e.push("main_buildlink_iron_12"),e}function setCookie(e,i,n){const o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3);const t="expires="+o.toUTCString();document.cookie=e+"="+i+";"+t+";path=/"}function getCookie(e){const i=e+"=",n=document.cookie.split(";");for(let e=0;e<n.length;e++){let o=n[e];for(;" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(i))return o.substring(i.length,o.length)}return null}function checkCookie(e){return null!==getCookie(e)}function eraseCookie(e){document.cookie=e+"=; Max-Age=-99999999; path=/"}function verificarEstatua(){if(isRecruiting)return;if(checkCookie(COOKIE_RECRUTAMENTO))return void console.log("Recrutamento já realizado anteriormente.");if(!getCurrentBuildings())return void console.log("Não foi possível obter os níveis dos edifícios.");let e=document.querySelector("#main_buildrow_statue > td:nth-child(1) > span").textContent;console.log("Nível atual da estátua: "+e),"Nível 1"==e&&(console.log("Estátua atingiu o nível alvo. Iniciando recrutamento do paladino."),iniciarRecrutamentoPaladino())}function getCurrentBuildings(){if("undefined"!=typeof unsafeWindow&&unsafeWindow.game_data&&unsafeWindow.game_data.village&&unsafeWindow.game_data.village.buildings)return unsafeWindow.game_data.village.buildings;return{main:getBuildingLevel("main"),statue:getBuildingLevel("statue")}}function getBuildingLevel(e){let i=document.querySelector(`#main_buildlink_${e} a`);if(i){let e=i.textContent.match(/\d+/);return e?e[0]:null}return null}async function iniciarRecrutamentoPaladino(){isRecruiting=!0,console.log("Processo de recrutamento iniciado. Pausando construções.");try{let e=await recrutarPaladino();if(console.log("Recrutamento do paladino concluído:",e),e&&e.error)return void console.error("Erro no recrutamento do paladino:",e.error);if(!(e&&e.knight&&e.knight.id))return void console.log("Resposta inesperada ao recrutar o paladino.");{let i=e.knight.id;console.log("ID do Paladino Recrutado:",i);let n=await acelerarRecrutamento(i);if(console.log("Aceleração do recrutamento concluída:",n),n&&n.error)return void console.error("Erro ao acelerar o recrutamento:",n.error);setCookie(COOKIE_RECRUTAMENTO,"true",DIAS_VALIDADE_COOKIE),console.log("Recrutamento bem-sucedido. Cookie definido.")}}catch(e){console.error("Erro durante o recrutamento do paladino:",e)}finally{isRecruiting=!1,console.log("Processo de recrutamento concluído. Retomando construções.")}}async function recrutarPaladino(){if(!currentVillageId||!csrfToken)return console.log("Dados necessários para recrutamento não disponíveis."),null;let e=`https://${window.location.host}/game.php?village=${currentVillageId}&screen=statue&ajaxaction=recruit`,i=new URLSearchParams;i.append("home",currentVillageId),i.append("name","Paul"),i.append("h",csrfToken);let n=await fetch(e,{method:"POST",headers:{Accept:"application/json, text/javascript, */*; q=0.01","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:i.toString(),credentials:"include"});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}async function acelerarRecrutamento(e){if(!currentVillageId||!csrfToken||!e)return console.log("Dados necessários para acelerar recrutamento não disponíveis."),null;let i=`https://${window.location.host}/game.php?village=${currentVillageId}&screen=statue&ajaxaction=recruit_rush`,n=new URLSearchParams;n.append("knight",e),n.append("home",currentVillageId),n.append("h",csrfToken);let o=await fetch(i,{method:"POST",headers:{Accept:"application/json, text/javascript, */*; q=0.01","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:n.toString(),credentials:"include"});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);let t=await o.json();return console.log("Resposta da aceleração:",t),t&&t.error?(console.error("Erro na aceleração:",t.error),t):t}function collectQuestRewards(){console.log("Iniciando coleta de recompensas de quests.");const e=document.querySelector(".popup_box_content");if(e&&isElementVisible(e))return console.log("Popup de quests já está aberto."),void processRewards();let i=document.querySelector("#new_quest");if(!i)return void console.log("Botão para abrir o popup de quests não encontrado.");i.click(),console.log("Clicou no botão que abre o popup de quests.");let n=setInterval((function(){const e=document.querySelector(".popup_box_content");e&&isElementVisible(e)&&(clearInterval(n),console.log("Popup de quests aberto."),processRewards())}),500)}function processRewards(){let e=document.querySelector('a.tab-link[data-tab="reward-tab"]');if(!e)return console.log("Aba 'Recompensas' não encontrada."),void fecharPopup();e.click(),console.log("Clicou na aba 'Recompensas'."),setTimeout((function(){let e=document.querySelectorAll(".reward-system-claim-button");e.length>0?(console.log(`Encontrou ${e.length} botões 'Reivindicar'.`),e.forEach((function(e,i){!e.disabled&&isElementVisible(e)&&setTimeout((function(){e.click(),console.log(`Clicou no botão 'Reivindicar' com data-reward-id=${e.getAttribute("data-reward-id")}.`)}),500*i)}))):console.log("Nenhum botão 'Reivindicar' encontrado."),setTimeout((function(){document.querySelectorAll(".btn.btn-confirm-yes").forEach((function(e){isElementVisible(e)&&setTimeout((function(){e.click(),console.log("Clicou no botão de confirmação.")}),500)})),setTimeout((function(){fecharPopup()}),1e3)}),2e3)}),1500)}function fecharPopup(){let e=document.querySelector(".popup_box_content a.close")||document.querySelector(".popup_box_content a.popup_close")||document.querySelector(".popup_box_content a.btn-close");if(e&&isElementVisible(e))e.click(),console.log("Fechou o popup de quests clicando no botão de fechar.");else{console.log("Botão de fechar popup não encontrado. Tentando pressionar Esc.");let e=new KeyboardEvent("keydown",{key:"Escape",keyCode:27,which:27});document.dispatchEvent(e)}}function isElementVisible(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)}function createBuildingUI(){if(document.getElementById("building-ui"))return;let e=document.createElement("div");e.id="building-ui",e.style.position="fixed",e.style.top="50px",e.style.left="10px",e.style.padding="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="#fff",e.style.fontSize="14px",e.style.borderRadius="5px",e.style.zIndex="1000",e.style.fontFamily="Arial, sans-serif",e.style.boxShadow="0 0 10px rgba(0,0,0,0.5)",e.innerHTML="<strong>Próximo Edifício:</strong> Nenhum",document.body.appendChild(e)}function updateBuildingUI(e){let i=document.getElementById("building-ui");i&&(i.innerHTML=`<strong>Próximo Edifício:</strong> ${e}`)}setTimeout((function(){let e=getEvoluir_vilas();if(console.log("Ação após delay. Evoluir_vilas: "+e),e===Edificio_Principal)isRecruiting||Proxima_Construção();else if(e===Visualização_Geral){let e=document.getElementById("l_main");e&&e.children.length>0&&e.children[0].children.length>0?(e.children[0].children[0].click(),console.log("Clicou no botão de Visualização Geral.")):console.log("Botão de Visualização Geral não encontrado.")}}),delay);
